const { v2: cloudinary } = require('cloudinary');
const streamifier = require('streamifier');

const uploadToCloudinary = (file) => {
  return new Promise((resolve, reject) => {
    console.log('Starting Cloudinary upload for file:', file.originalname);
    console.log('Cloudinary config:', {
      cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
      upload_preset: process.env.CLOUDINARY_UPLOAD_PRESET,
    });
    const uploadStream = cloudinary.uploader.upload_stream(
      {
        folder: 'sales_summary',
        upload_preset: process.env.CLOUDINARY_UPLOAD_PRESET,
      },
      (error, result) => {
        if (error) {
          console.error('Cloudinary upload error:', error.message, error);
          reject(new Error(`Cloudinary upload failed: ${error.message}`));
        } else {
          console.log('Cloudinary upload successful:', {
            url: result.secure_url,
            public_id: result.public_id,
          });
          resolve({
            url: result.secure_url,
            public_id: result.public_id,
          });
        }
      }
    );
    streamifier.createReadStream(file.buffer).pipe(uploadStream);
  });
};

module.exports = { uploadToCloudinary };